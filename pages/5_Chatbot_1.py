import streamlit as st
import pandas as pd
from openai import OpenAI, OpenAIError
from codecarbon import EmissionsTracker
import random
from theme import apply_theme

# Streamlit Page Setup
st.set_page_config(page_title="Chatbot Carbon Emission Tracker", layout="centered")

apply_theme()

st.title("ğŸŒ± Chatbot Carbon Emission Tracker")
st.caption("ğŸš€ A Streamlit chatbot powered by OpenAI + CodeCarbon tracking ğŸŒ±")

# User Guide in Expander
with st.expander("ğŸ“˜ Chatbot Carbon Emission Tracker User Guide"):
    st.markdown("""
    This app compares carbon emissions generated by two different AI model configurations when answering your question.

    **Steps to use:**
    1. ğŸ” Enter your **OpenAI API Key** in the sidebar.
    2. ğŸ’¬ Type your question in the **chat input** at the bottom of the screen.
    3. ğŸ“Š Wait for the two responses:
        - **Normal Model** (more creative, higher emissions)
        - **Green Model** (more efficient, deterministic)
    4. ğŸŒ View the estimated **COâ‚‚ emissions** for each response.
    5. ğŸ“ˆ See a **bar chart** comparing emissions in the sidebar.

    ---
    **Tips:**
    - Use short, clear prompts for best results.
    - Try sustainability-related questions like:
        - "How can I reduce my home's carbon footprint?"
        - "What are green alternatives to air travel?"
        - "Explain carbon offsetting in simple terms."

    âœ… Use this app to explore how even digital choices can affect our environment!
    """)

# Sidebar Setup
with st.sidebar:
    openai_api_key = st.text_input("OpenAI API Key", key="chatbot_api_key", type="password")
    "[Get an OpenAI API key](https://platform.openai.com/account/api-keys)"

st.sidebar.title("ğŸŒ Emissions Summary")

# Set up OpenAI client
client = None
if openai_api_key:
    try:
        client = OpenAI(api_key=openai_api_key)
        # Optional: test the key by sending a lightweight call
        client.models.list()  # Just to validate the key
    except OpenAIError:
        st.error("âŒ Invalid OpenAI API key. Please double-check and try again.")
        client = None


# Chat input
prompt = st.chat_input("Ask something about carbon emissions...")

if prompt and not openai_api_key:
    st.warning("âš ï¸ Please enter your OpenAI API key in the sidebar to use the chatbot.")
    
if openai_api_key and prompt:
    with st.spinner("Generating responses and tracking emissions..."):
        try:
            MAX_TOKENS = 500

            # Tracker for temperature 1.0 (normal model)
            tracker_normal = EmissionsTracker(project_name="Temp 1.0")
            tracker_normal.start()
            response_normal = client.chat.completions.create(
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                temperature=1.0,
                max_tokens=MAX_TOKENS,
                presence_penalty=1.0,
                frequency_penalty=0.5
            )
            emissions_normal = tracker_normal.stop()

            # Tracker for temperature 0.2 (green model)
            tracker_greenmodel = EmissionsTracker(project_name="Temp 0.2")
            tracker_greenmodel.start()
            response_greenmodel = client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.2,
                max_tokens=MAX_TOKENS,
            )
            emissions_greenmodel = tracker_greenmodel.stop()

            # Convert to grams
            emissions_normal_grams = emissions_normal * 1000
            emissions_greenmodel_grams = emissions_greenmodel * 1000


        except Exception as e:
            st.error(f"An error occurred: {e}")

        else:
            # Only display if no error
            st.subheader("ğŸ“¥ Your Prompt")
            st.code(prompt, language="markdown")

            st.subheader("Results")
            st.write("### ğŸŸ£ Response with Normal Model:")
            st.info(response_normal.choices[0].message.content)
            st.write(f"ğŸŒ Emissions for Normal Model: `{emissions_normal_grams:.4f} grams COâ‚‚`")

            st.write("---")

            st.write("### ğŸ”µ Response with Green Model:")
            st.success(response_greenmodel.choices[0].message.content)
            st.write(f"ğŸŒ Emissions for Green Model: `{emissions_greenmodel_grams:.4f} grams COâ‚‚`")

            # Sidebar Update
            with st.sidebar:
                st.metric(label="Emissions Normal Model", value=f"{emissions_normal_grams:.4f} g COâ‚‚")
                st.metric(label="Emissions Green Model", value=f"{emissions_greenmodel_grams:.4f} g COâ‚‚")
        

                st.write("---")
                st.write("ğŸ“Š **Emission Comparison Chart**")
                df_emissions = pd.DataFrame({
                    "Model": ["Normal Model", "Green Model"],
                    "COâ‚‚ Emissions (grams)": [emissions_normal_grams, emissions_greenmodel_grams]
                })
                st.bar_chart(df_emissions.set_index("Model"))

# Random Eco Tip or Fact
did_you_know_facts = [
    "ğŸŒ± It would take 45 billion trees ğŸŒ³ a whole year to absorb 1 billion tonnes of COâ‚‚!",
    "âœˆï¸ 1 billion people flying from New York to London equals 500 millions tonnes of COâ‚‚!",
    "ğŸŒ The average car emits about 4.6 metric tonnes of COâ‚‚ per year.",
    "ğŸ¡ Heating and cooling buildings accounts for about 50% of global energy use.",
]

eco_tips = [
    "ğŸ’¡ Switch off lights and electronics when not in use.",
    "ğŸš´â€â™‚ï¸ Walk, cycle, or carpool whenever possible.",
    "â™»ï¸ Reduce, Reuse, and Recycle â€” the 3 magic R's!",
    "ğŸƒ Compost food scraps to reduce landfill emissions.",
    "ğŸ›’ Bring your own reusable bag when shopping.",
    "ğŸ’§ Fix leaking taps to save thousands of liters of water yearly.",
    "ğŸ¥¦ Choose more plant-based meals to lower your carbon footprint.",
    "ğŸ”‹ Use rechargeable batteries whenever possible.",
]

category = random.choice(["fact", "tip"])
if category == "fact":
    opening_word = "ğŸŒ **Did You Know?**"
    random_message = random.choice(did_you_know_facts)
else:
    opening_word = "ğŸŒ¿ **Green Tip of the Day:**"
    random_message = random.choice(eco_tips)

with st.sidebar:
    st.info(f"{opening_word}\n\n{random_message}")
